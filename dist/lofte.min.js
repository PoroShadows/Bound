function Lofte(a){function g(a){try{if(a&&"function"==typeof a.then)return a.then(g,h);b=1,c=a,d&&k(d)}catch(a){h(a)}}function h(a){b=2,c=a,d&&k(d)}function i(a){try{for(var b=0,c=e[b];b<e.length;b++,c=e[b])c(a)}catch(a){}}function j(a){f=a}function k(a){function e(){if(0===b)return void(d=a);a===d&&(d=void 0);var e=1===b?a.onResolved:a.onRejected;if("function"!=typeof e)return a[1===b?"resolve":"reject"](c);try{var f=e(c);a.resolve(f)}catch(b){a.reject(b)}}3!==b&&("undefined"!=typeof process&&"function"==typeof process.nextTick?process.nextTick(e):setTimeout(e,0))}function l(a,b,c){return a.then(function(a){function d(a){return Array.isArray(a)||"object"==typeof a&&"length"in a&&a.length-1 in a}var e,f=(e=d(a))?a:[a];return f=Array.prototype[b].apply(f,c),d(f)&&1===f.length?e?f:f[0]:f})}var c,d,b=0,e=[],f=function(){};this.then=function(a,b){return new Lofte(function(c,d){k({onResolved:a,onRejected:b,resolve:c,reject:d})})},this.catch=function(a){return this.then(null,a)},this.isPending=function(){return 0==b},this.isResolved=function(){return 1==b},this.isRejected=function(){return 2==b},this.isCanceled=function(){return 3==b},this.callback=function(a,b){return a&&"function"==typeof a?void this.then(function(c){a.call(b,null,c)},function(c){a.call(b,c)}):this.then()},this.delay=function(a){return this.then(function(b){return new Lofte(function(c){setTimeout(function(){c(b)},a)})},function(b){return new Lofte(function(c,d){setTimeout(function(){d(b)},a)})})},this.cancel=function(){f(),b=3},this.onNotify=function(a){for(var b=0,c=arguments[b];b<arguments.length;b++,a=arguments[b]){if("function"!=typeof c)throw new TypeError("onNotify: argument "+(b+1)+" is not a function");e.push(c)}return this},this.reduce=function(a,b){return l(this,"reduce",[a,b])},this.filter=function(a,b){return l(this,"filter",[a,b])},this.map=function(a,b){return l(this,"map",[a,b])},this.finally=function(a){return this.then(function(b){return Lofte.resolve(a()).then(function(){return b})},function(b){return Lofte.resolve(a()).then(function(){throw b})})},this.fail=function(a){return this.then(null,a)},this.lastly=function(a){return this.then(function(b){return Lofte.resolve(a()).then(function(){return b})},function(b){return Lofte.resolve(a()).then(function(){throw b})})};try{a(g,h,j,i)}catch(a){h(a)}}Lofte.resolve=function(a){return new Lofte(function(b){b(a)})},Lofte.reject=function(a){return new Lofte(function(b,c){c(a)})},Lofte.all=function(a){return new Lofte(function(b,c,d,e){var f=!1;d(function(){f=!0});var g=function(){function a(a){return function(c){f||(h[a]=c,i.push(a),e(c),i.length===j&&b(h))}}return function(b){Lofte.resolve(b).then(a(j++),c)}}(),h=[],i=[],j=0;if("function"==typeof a&&"function"==typeof a().next||"function"==typeof a.next){var l,k="function"==typeof a.next?a:a(),m=!0;do{if(l=k.next(),l.done)break;m=!1,g(l.value)}while(!l.done&&!f);m&&b()}else if("length"in a&&a.length>0)for(var n=0;n<a.length&&!f;n++)g(a[n]);else b()})},Lofte.race=function(a){return new Lofte(function(b,c,d){var e=!1;d(function(){e=!0});var f=function(){function a(a){return function(b){e||a(b)}}return function(d){Lofte.resolve(d).then(a(b),a(c))}}();if("function"==typeof a&&"function"==typeof a().next||"function"==typeof a.next){var h,g="function"==typeof a.next?a:a(),i=!0;do{if(h=g.next(),h.done)break;i=!1,f(h.value)}while(!h.done&&!e);i&&b()}else if("length"in a&&a.length>0)for(var j=0;j<a.length&&!e;j++)f(a[j]);else b()})},Lofte.promisify=function(a,b){return b="undefined"!=typeof b?b:{},b.argumentCount="undefined"!=typeof b.argumentCount?b.argumentCount:1/0,b.hasErrorArg="undefined"==typeof b.hasErrorArg||b.hasErrorArg,b.moreCBValues="undefined"!=typeof b.moreCBValues&&b.moreCBValues,function(){var c=this,d=Array.prototype.slice.call(arguments);return new Lofte(function(e,f){for(;d.length&&d.length>b.argumentCount;)d.pop();for(;d.length&&isFinite(b.argumentCount)&&d.length<b.argumentCount;)d.push(void 0);d.push(function(a,c){b.moreCBValues?b.hasErrorArg?a?f(a):e(Array.prototype.slice.call(arguments,1)):e(Array.prototype.slice.call(arguments)):b.hasErrorArg?a?f(a):e(c):e(a)});var g=a.apply(c,d);g&&e(g)})}},Lofte.flow=function(a){function c(a){if(a.done)return Lofte.resolve(a.value);var c,b=a.value;return c="function"==typeof b.then?b:"function"==typeof b&&"function"==typeof b().next||"function"==typeof b.next||"object"==typeof b&&"length"in b&&b.length>0&&b.length-1 in b?Lofte.all(b):Lofte.resolve(b),c.then(d("next"),d("throw"))}function d(b){return function(d){c(a[b](d))}}var b=Array.prototype.splice.call(arguments,1);return"function"==typeof a&&(a=a.apply(this,b)),c(a.next())};